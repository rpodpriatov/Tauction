{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1 class="mb-4">{{ auction.title }}</h1>
        <div class="card mb-4">
            <div class="card-body">
                <p class="card-text">{{ auction.description }}</p>
                <p class="card-text"><strong>Current Price:</strong> {{ auction.current_price }} XTR</p>
                <p class="card-text"><strong>Time Remaining:</strong> <span id="countdown"></span></p>
                <p class="card-text"><strong>Creator:</strong> {{ auction.creator.username }}</p>
                
                {% if current_user.is_authenticated %}
                    {% if auction in current_user.watchlist %}
                        <form action="{{ url_for('remove_from_watchlist', auction_id=auction.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger"><i class="fas fa-star"></i> Remove from Watchlist</button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('add_to_watchlist', auction_id=auction.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-primary"><i class="far fa-star"></i> Add to Watchlist</button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {% if auction.is_active and current_user.is_authenticated %}
            <div class="card mb-4">
                <div class="card-body">
                    <h3 class="card-title">Place a Bid</h3>
                    <form method="POST" action="{{ url_for('auction_detail', auction_id=auction.id) }}">
                        {{ bid_form.hidden_tag() }}
                        <div class="mb-3">
                            {{ bid_form.amount.label(class="form-label") }}
                            {{ bid_form.amount(class="form-control", placeholder="Enter your bid amount") }}
                            {% for error in bid_form.amount.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ bid_form.submit(class="btn btn-success") }}
                        </div>
                    </form>
                </div>
            </div>
        {% elif not current_user.is_authenticated %}
            <p class="alert alert-warning">Please <a href="{{ url_for('auth.login') }}">login</a> to place a bid.</p>
        {% endif %}
    </div>

    <div class="col-md-4">
        <h3 class="mb-3">Bid History</h3>
        {% if bids %}
            <ul class="list-group">
                {% for bid in bids %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ bid.bidder.username }}</strong> bid
                            <strong>{{ bid.amount }} XTR</strong>
                        </div>
                        <small class="text-muted">{{ bid.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="alert alert-info">No bids yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Countdown timer
    function updateCountdown() {
        const now = new Date().getTime();
        const endTime = new Date("{{ auction.end_time }}").getTime();
        const timeLeft = endTime - now;

        if (timeLeft > 0) {
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById("countdown").innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        } else {
            document.getElementById("countdown").innerHTML = "Auction has ended";
        }
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
</script>
{% endblock %}
