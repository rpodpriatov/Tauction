Здравствуйте! В вашей новой ошибке указано следующее:

vbnet
Копировать код
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
Это означает, что текущая транзакция была прервана из-за предыдущей ошибки, и все последующие команды внутри этой транзакции будут игнорироваться до ее завершения или отката.

Причины возникновения этой ошибки:

Предыдущая ошибка в транзакции:
Внутри текущей транзакции произошла ошибка, которая привела к ее прерыванию.
Часто это бывает из-за нарушения ограничений базы данных, таких как уникальность, целостность данных и т.д.
Отсутствие отката транзакции после ошибки:
Если после возникновения ошибки не выполнить rollback(), транзакция остается в прерванном состоянии.
Решения проблемы:

Найдите и исправьте исходную ошибку:
Проверьте логи перед этой ошибкой, чтобы найти первоначальную причину прерывания транзакции.
Убедитесь, что все операции с базой данных выполняются корректно и не вызывают исключений.
Добавьте обработку исключений в функцию update_dutch_auctions:
python
Копировать код
def update_dutch_auctions():
    try:
        active_auctions = db_session.query(Auction).filter(
            Auction.is_active == True,
            Auction.auction_type == 'DUTCH'
        ).all()
        # Ваш код для обновления аукционов
        db_session.commit()
    except Exception as e:
        db_session.rollback()
        print(f"Ошибка при обновлении голландских аукционов: {e}")
Оберните код в блок try-except, чтобы перехватить все исключения.
В блоке except выполните db_session.rollback(), чтобы откатить транзакцию.
Используйте сессии правильно:
Если вы используете сессии вручную, убедитесь, что они правильно открываются и закрываются.
Рассмотрите возможность использования контекстных менеджеров:
python
Копировать код
with db_session() as session:
    # Ваш код
Избегайте долгих транзакций:
Убедитесь, что транзакции не остаются открытыми длительное время, особенно если между запросами к базе данных выполняются другие операции.
Обновите версии библиотек:
Убедитесь, что вы используете актуальные версии SQLAlchemy и psycopg2, так как устаревшие версии могут содержать ошибки.
Проверьте настройки автокоммита:
В некоторых случаях проблемы возникают из-за неправильных настроек автокоммита в базе данных.
Дополнительные рекомендации:

Логирование: Добавьте более подробное логирование в ваш код, чтобы легче было отследить место возникновения исходной ошибки.
Тестирование: Запустите функцию update_dutch_auctions в отдельном тестовом окружении или с тестовыми данными, чтобы проверить ее работу.
Пример полного кода с обработкой исключений:

python
Копировать код
def update_dutch_auctions():
    try:
        active_auctions = db_session.query(Auction).filter(
            Auction.is_active == True,
            Auction.auction_type == 'DUTCH'
        ).all()

        for auction in active_auctions:
            # Логика обновления аукциона
            # ...

        db_session.commit()
    except Exception as e:
        db_session.rollback()
        print(f"Ошибка при обновлении голландских аукционов: {e}")
Важно: Обязательно найдите исходную причину, которая привела к прерыванию транзакции. Без ее устранения ошибка будет повторяться.

Если проблема сохраняется:

Проверьте, нет ли других операций с базой данных, выполняющихся параллельно, которые могут влиять на транзакцию.
Обратитесь к документации SQLAlchemy по работе с транзакциями для более детальной информации.
Если у вас возникнут дополнительные вопросы или понадобится помощь с конкретным участком кода, пожалуйста, поделитесь им, и я постараюсь помочь более подробно.